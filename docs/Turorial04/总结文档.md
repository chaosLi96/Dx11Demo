# Tutorial04 讲解：逐步搭建 DirectX 11 旋转立方体

> 目标：理解示例中出现的每个 Direct3D 11 接口、为什么要这样设置参数，以及每帧是怎么跑起来的。可以配合同目录下的 `init_flow.puml`、`frame_render.puml`、`data_objects.puml` 查看流程和对象关系。

## 场景与资料
- 示例：渲染一个持续绕 Y 轴旋转的带顶点色立方体。
- 核心文件：`code/Tutorial04/Tutorial04.cpp`、`code/Tutorial04/Tutorial04.fx`。
- 数据结构：
  - `SimpleVertex { XMFLOAT3 Pos; XMFLOAT4 Color; }` —— 顶点位置+颜色。
  - `ConstantBuffer { XMMATRIX mWorld; mView; mProjection; }` —— 舞台三矩阵。

## 初始化主线（WinMain → InitWindow → InitDevice）
1) **窗口**：普通 Win32 窗口（640x480，类名 `TutorialWindowClass`），仅做消息泵和展示。

2) **创建设备+交换链** — `D3D11CreateDeviceAndSwapChain`  
   - 适配器：`NULL`（默认 GPU）；驱动类型轮询 Hardware → WARP → Reference。  
   - 调试：`D3D11_CREATE_DEVICE_DEBUG`（可选，Debug 版）。  
   - 特性级别：优先 11.0，降级到 10.1 / 10.0。  
   - 交换链描述 `DXGI_SWAP_CHAIN_DESC`：`BufferCount=1`；`Format=DXGI_FORMAT_R8G8B8A8_UNORM`；`RefreshRate=60/1`；`Usage=DXGI_USAGE_RENDER_TARGET_OUTPUT`；窗口模式；`SampleDesc.Count=1`（关闭 MSAA）。

3) **渲染目标视图 RTV**  
   - `IDXGISwapChain::GetBuffer(0, __uuidof(ID3D11Texture2D), …)` 取后台缓冲。  
   - `ID3D11Device::CreateRenderTargetView(backBuffer, NULL, &RTV)`。  
   - `OMSetRenderTargets(1, &RTV, NULL)` 绑定（本例无深度缓冲）。

4) **视口** — `RSSetViewports`  
   - `TopLeftX/Y=0`，`Width/Height=窗口大小`，`MinDepth=0`，`MaxDepth=1`。

5) **着色器编译与创建**  
   - `D3DX11CompileFromFile(L"Tutorial04.fx", …, entry="VS"/"PS", model="vs_4_0"/"ps_4_0", flags=D3DCOMPILE_ENABLE_STRICTNESS [+ DEBUG])`。  
   - `CreateVertexShader` / `CreatePixelShader` 从 blob 创建 VS/PS。

6) **输入布局** — `CreateInputLayout`  
   - 描述两条语义：  
     - `POSITION`, 0, `DXGI_FORMAT_R32G32B32_FLOAT`, Slot0, Offset0  
     - `COLOR`, 0, `DXGI_FORMAT_R32G32B32A32_FLOAT`, Slot0, Offset12  
   - 绑定：`IASetInputLayout`.

7) **顶点/索引缓冲**  
   - 顶点：8 个位置+颜色；`D3D11_BUFFER_DESC`：`Usage=DEFAULT`，`BindFlags=D3D11_BIND_VERTEX_BUFFER`，`CPUAccessFlags=0`；`CreateBuffer` + `IASetVertexBuffers(slot=0, stride=sizeof(SimpleVertex), offset=0)`。  
   - 索引：WORD 数组 36 个索引（12 三角形）；`BindFlags=D3D11_BIND_INDEX_BUFFER`，`DXGI_FORMAT_R16_UINT`；`IASetIndexBuffer`.

8) **拓扑** — `IASetPrimitiveTopology(D3D11_PRIMITIVE_TOPOLOGY_TRIANGLELIST)`。

9) **常量缓冲**  
   - `ByteWidth=sizeof(ConstantBuffer)`（16 字节对齐），`Usage=DEFAULT`，`BindFlags=D3D11_BIND_CONSTANT_BUFFER`。  
   - VS 绑定：`VSSetConstantBuffers(slot=0, &CB)`。

10) **矩阵初始化**  
    - 世界：`XMMatrixIdentity()`。  
    - 视图：`XMMatrixLookAtLH(Eye(0,1,-5), At(0,1,0), Up(0,1,0))`。  
    - 投影：`XMMatrixPerspectiveFovLH(fov=XM_PIDIV2, aspect=width/height, zn=0.01f, zf=100.0f)`。

## 每帧渲染（Render）
1) **时间更新**：参考设备固定步长，否则用 `GetTickCount()` 计算秒数 `t`。  
2) **世界变换**：`g_World = XMMatrixRotationY(t)` 让立方体绕 Y 轴转。  
3) **清屏**：`ClearRenderTargetView(RTV, {0, 0.125f, 0.3f, 1})`。  
4) **更新常量缓冲** — `UpdateSubresource(CB, …)`，传入转置后的 World/View/Projection（三者转置是因为 HLSL 默认列主序，C++ 常量为行主序）。  
5) **绑定绘制**：`VSSetShader` → `VSSetConstantBuffers` → `PSSetShader` → `DrawIndexed(36, 0, 0)`。  
6) **显示**：`IDXGISwapChain::Present(0, 0)` 立即翻转。

## HLSL 概览（Tutorial04.fx）
- 常量缓冲：`cbuffer ConstantBuffer : register(b0)`，含 `World`、`View`、`Projection`。  
- VS：输入 `POSITION / COLOR`，依次乘以 `World` → `View` → `Projection`，输出 `SV_POSITION` 和颜色。  
- PS：直接返回输入颜色。  
- 语义：`SV_POSITION`（裁剪后位置信息），`COLOR0`（插值颜色）。

## 常见参数/接口要点（按出现顺序）
- `D3D11CreateDeviceAndSwapChain`：最关键的创建入口，确保 `SDKVersion=D3D11_SDK_VERSION`，交换链格式/刷新率与窗口匹配。  
- `CreateRenderTargetView`：需释放从交换链 `GetBuffer` 拿到的纹理引用（本例先 RTV，再 release back buffer）。  
- `RSSetViewports`：必须设置，否则默认 0 尺寸。  
- `CreateInputLayout`：输入布局必须与 VS 输入签名完全匹配（语义+格式+槽+偏移）。  
- `CreateBuffer`：`Usage=DEFAULT` 且 `CPUAccessFlags=0` 适合静态 GPU 资源；常量缓冲大小需 16 字节对齐。  
- `UpdateSubresource`：本例用于每帧更新矩阵；若频繁更新可考虑 `D3D11_USAGE_DYNAMIC + Map/Unmap`。  
- `DrawIndexed`：索引格式与绑定格式必须一致（此处 `DXGI_FORMAT_R16_UINT`）。  
- `Present`：参数 `(0,0)` 表示不等待 vsync、不指定 flags；若想锁帧可把第一个参数设为 1。

## 调试与扩展建议
- 开启调试层：编译为 Debug 并添加 `D3D11_CREATE_DEVICE_DEBUG`，可在输出窗口看到 API 误用提示。  
- 深度测试：若想添加深度缓冲，需要创建深度模板纹理 + `DepthStencilView`，并在 `OMSetRenderTargets` 中一起绑定，同时清除深度。  
- 资源生命周期：所有 COM 对象在 `CleanupDevice` 中 `Release`；渲染前亦可调用 `ClearState` 清空上下文绑定。  
- 着色器与布局变更：调整顶点格式或 HLSL 语义时，需同步修改 `SimpleVertex`、输入布局和 FX 输入签名。

## 文件与图示
- 代码：`code/Tutorial04/Tutorial04.cpp`、`code/Tutorial04/Tutorial04.fx`。  
- PlantUML：`init_flow.puml`（初始化时序）、`frame_render.puml`（帧渲染流程）、`data_objects.puml`（核心对象关系），可用 PlantUML 渲染为 PNG/SVG。
